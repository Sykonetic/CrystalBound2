// src/index.js
import { World } from './world.js';

// --- Canvas + game loop basics ---
const canvas = document.getElementById('view');
const ctx = canvas.getContext('2d');

const game = {
  mouse: { x:0, y:0, wx:0, wy:0 },
  keys:  Object.create(null),
  running: true,
  runToggle: false, // Shift toggles run
};

const world = new World(game);

// camera (simple follow)
function cam() {
  const W = canvas.width, H = canvas.height;
  const x = Math.max(0, Math.min(world.w - W, world.player.x - W/2));
  const y = Math.max(0, Math.min(world.h - H, world.player.y - H/2));
  return {x,y};
}

// input
window.addEventListener('keydown', (e)=>{
  game.keys[e.key] = true;

  // run as toggle
  if (e.key === 'Shift') game.runToggle = !game.runToggle;

  // quick items
  if (e.key === 'q' || e.key === 'Q') { world.player.use('Potion', world); }
  if (e.key === 'e' || e.key === 'E') { world.player.use('Ether', world); }

  // melee
  if (e.key === 'j' || e.key === 'J') { world.player.attack(world); }

  // skills 1-4
  if (e.key >= '1' && e.key <= '4') {
    const slot = parseInt(e.key, 10);
    world.player.cast(slot, world, game.mouse);
  }

  // interact
  if (e.key === 'f' || e.key === 'F') world.tryInteract();
});

window.addEventListener('keyup', (e)=>{
  delete game.keys[e.key];
});

canvas.addEventListener('mousemove', (e)=>{
  const rect = canvas.getBoundingClientRect();
  game.mouse.x = e.clientX - rect.left;
  game.mouse.y = e.clientY - rect.top;
});

canvas.addEventListener('mousedown', (e)=>{
  // Left click = basic attack
  if (e.button === 0) world.player.attack(world);
});

// Controls panel population (includes skill names)
function refreshControlsPanel() {
  const box = document.getElementById('controlsList');
  if (!box) return;
  const skillList = world.player.skills().map(s => `[${s.slot}] ${s.name}`).join(', ');
  box.innerHTML = '';

  const rows = [
    ['Move', 'WASD / Arrows'],
    ['Run', 'Shift (toggle)'],
    ['Attack', 'Left Click or J'],
    ['Dodge', 'Space'],
    ['Interact', 'F'],
    ['Skills', skillList],
    ['Potion', 'Q'],
    ['Ether', 'E'],
  ];

  for (const [label, val] of rows) {
    const row = document.createElement('div');
    row.className = 'row';
    row.style.padding = '6px 8px';
    row.style.border = '1px solid #242a43';
    row.style.borderRadius = '8px';
    row.style.marginBottom = '6px';
    row.innerHTML = `<div><div class="title">${label}</div><div class="muted">${val}</div></div><div class="pill"> </div>`;
    box.appendChild(row);
  }
}
refreshControlsPanel();

// main loop
let last = performance.now();
function loop(now){
  if (!game.running) return;
  const dt = Math.min(0.033, (now - last) / 1000);
  last = now;

  // convert mouse to world coords
  const c = cam();
  game.mouse.wx = c.x + game.mouse.x;
  game.mouse.wy = c.y + game.mouse.y;

  // movement
  let dx = 0, dy = 0;
  if (game.keys['w'] || game.keys['ArrowUp'])    dy -= 1;
  if (game.keys['s'] || game.keys['ArrowDown'])  dy += 1;
  if (game.keys['a'] || game.keys['ArrowLeft'])  dx -= 1;
  if (game.keys['d'] || game.keys['ArrowRight']) dx += 1;

  // dodge (Space)
  if (game.keys[' ']) { world.player.dodge(world); delete game.keys[' ']; }

  world.player.move(dx, dy, game.runToggle, dt, world);
  world.update(dt);

  // draw
  ctx.save();
  ctx.translate(-c.x, -c.y);
  world.draw(ctx, game.mouse);
  ctx.restore();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Update controls panel if class changes later
window.addEventListener('change', (e)=>{
  if (e.target && e.target.id === 'classSelect') {
    world.player.setClass(e.target.value);
    refreshControlsPanel();
  }
});
